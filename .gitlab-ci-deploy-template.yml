#
# IMPORTANT: Do not rename this file or move to another folder. Doing so would
#            break the CI pipelines of projects that "include:" this file.
#
# Included Variables
include:
  .gitlab-ci-build-vars.yml

stages:
- generate-yml
- deploy-image
- deploy-to-test

variables:
  PROJECT_PATH: gcp-solutions/hcls/claims-modernization/gitlab-ci
  TRIGGER_FILE: .gitlab-ci-trigger-template.yml

create:
  stage: generate-yml
  script:
  - cat ${VARIABLES_FILE}
  - source ${VARIABLES_FILE}
  - echo $IMAGE
  - apk update
  - apk add git
  - git clone https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${PROJECT_PATH}.git $(basename ${PROJECT_PATH})
  - >
    sed  's|__PROJECT__|'"${DEPLOY_PROJECT}"'|g;
          s|__BRANCH__|'"${TRIGGER_BRANCH}"'|g;
          s|__IMAGE__|'"${IMAGE}"'|g;
          s|__UPSTREAM_PROJECT_NAME__|'"${CI_PROJECT_NAME}"'|g;
          s|__UPSTREAM_PROJECT_PATH__|'"${CI_PROJECT_PATH}"'|g;
          s|__ENVIRONMENT__|'"${ENVIRONMENT}"'|g;
          s|__NAMESPACE__|'"${NAMESPACE}"'|g;
    '
    $(basename ${PROJECT_PATH})/"${TRIGGER_FILE}" > ${TRIGGER_FILE}
  rules:
  - if: $CI_PIPELINE_SOURCE == 'merge_request_event' || $CI_COMMIT_TAG || $CI_COMMIT_BRANCH
    when: always
  artifacts:
    paths:
    - ${TRIGGER_FILE}

execute:
  stage: deploy-image
  trigger:
    include:
    - artifact: ${TRIGGER_FILE}
      job: create
    strategy: depend
  rules:
  - if: $CI_PIPELINE_SOURCE == 'merge_request_event' || $CI_COMMIT_TAG || $CI_COMMIT_BRANCH
    when: always

#deploy to test:
#  stage: deploy-to-test
#  trigger:
#    include:
#    - artifact: ${TRIGGER_FILE}
#      job: deploy-to-test
#    strategy: depend
#  when: manual